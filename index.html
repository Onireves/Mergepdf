<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Studio Pro</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        dark: {
                            bg: '#0F0F0F',
                            surface: '#1A1A1A',
                            border: '#2A2A2A'
                        }
                    },
                    boxShadow: {
                        'soft': '0 20px 40px -15px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px rgba(59, 130, 246, 0.15)'
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }

        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #2563eb; margin-top: -6px; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #333; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        .toggle-checkbox { right: auto; }
        
        /* Spinner */
        .loader {
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff;
            width: 16px; height: 16px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Quality Options Grid */
        .quality-option {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .quality-option.active {
            background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8;
        }
        .dark .quality-option.active {
            background-color: rgba(59, 130, 246, 0.15); border-color: #3b82f6; color: #60a5fa;
        }

        /* Drop Zone Animation */
        .drop-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%23CBD5E1' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s ease;
        }
        .dark .drop-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%23334155' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .drop-zone.dragover {
            transform: scale(1.01);
            background-color: rgba(59, 130, 246, 0.05);
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%233B82F6' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="bg-[#F8FAFC] dark:bg-dark-bg text-slate-800 dark:text-slate-200 h-screen flex overflow-hidden selection:bg-brand-100 dark:selection:bg-blue-900">

    <!-- Sidebar -->
    <aside class="w-80 bg-white dark:bg-dark-surface border-r border-slate-200 dark:border-dark-border flex flex-col z-20 shadow-xl shadow-slate-200/50 dark:shadow-none flex-shrink-0">
        
        <!-- Header -->
        <div class="p-6 pb-2">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center text-white shadow-glow">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight text-slate-900 dark:text-white leading-tight">PDF Studio</h1>
                    <p class="text-xs text-slate-500 font-medium">Professional Merger</p>
                </div>
            </div>

            <div class="space-y-6">
                <!-- File Name Input -->
                <div>
                    <label class="text-[11px] uppercase font-bold text-slate-400 tracking-wider mb-2 block">Output Filename</label>
                    <div class="relative group">
                        <i class="fa-regular fa-file-pdf absolute left-3 top-2.5 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                        <input type="text" id="filenameInput" value="merged_document" 
                            class="w-full bg-slate-50 dark:bg-[#252525] border border-slate-200 dark:border-dark-border rounded-xl py-2 pl-9 pr-12 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all font-medium text-slate-700 dark:text-slate-300">
                        <span class="absolute right-3 top-2.5 text-xs text-slate-400 font-medium">.pdf</span>
                    </div>
                </div>

                <!-- ID Mode Toggle -->
                <div class="bg-slate-50 dark:bg-[#252525] p-3 rounded-xl border border-slate-200 dark:border-dark-border flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center">
                            <i class="fa-regular fa-id-card text-xs"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold text-slate-700 dark:text-slate-200">ID Card Mode</span>
                            <span class="text-[10px] text-slate-400">Merge first 2 items</span>
                        </div>
                    </div>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" id="idModeToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer border-slate-300 left-0 transition-all duration-300"/>
                        <label for="idModeToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 dark:bg-slate-600 cursor-pointer"></label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scrollable Settings -->
        <div class="flex-grow overflow-y-auto px-6 py-2">
            
            <div class="py-4 border-t border-slate-100 dark:border-dark-border">
                <label class="text-[11px] uppercase font-bold text-slate-400 tracking-wider mb-3 block">Quality & Size</label>
                
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button class="quality-option active p-3 rounded-xl border border-slate-200 dark:border-dark-border bg-white dark:bg-[#252525] text-left hover:border-brand-300 transition-all group" data-value="medium">
                        <div class="flex justify-between items-start mb-1">
                            <i class="fa-solid fa-scale-balanced text-xs text-slate-400 group-[.active]:text-brand-500"></i>
                            <div class="w-2 h-2 rounded-full bg-slate-200 group-[.active]:bg-brand-500"></div>
                        </div>
                        <div class="text-xs font-semibold">Balanced</div>
                        <div class="text-[10px] text-slate-400 opacity-80">Recommended</div>
                    </button>

                    <button class="quality-option p-3 rounded-xl border border-slate-200 dark:border-dark-border bg-white dark:bg-[#252525] text-left hover:border-brand-300 transition-all group" data-value="best">
                        <div class="flex justify-between items-start mb-1">
                            <i class="fa-regular fa-image text-xs text-slate-400 group-[.active]:text-brand-500"></i>
                            <div class="w-2 h-2 rounded-full bg-slate-200 group-[.active]:bg-brand-500"></div>
                        </div>
                        <div class="text-xs font-semibold">Best</div>
                        <div class="text-[10px] text-slate-400 opacity-80">Max Quality</div>
                    </button>

                    <button class="quality-option p-3 rounded-xl border border-slate-200 dark:border-dark-border bg-white dark:bg-[#252525] text-left hover:border-brand-300 transition-all group" data-value="small">
                        <div class="flex justify-between items-start mb-1">
                            <i class="fa-solid fa-compress text-xs text-slate-400 group-[.active]:text-brand-500"></i>
                            <div class="w-2 h-2 rounded-full bg-slate-200 group-[.active]:bg-brand-500"></div>
                        </div>
                        <div class="text-xs font-semibold">Smallest</div>
                        <div class="text-[10px] text-slate-400 opacity-80">Email ready</div>
                    </button>

                    <button class="quality-option p-3 rounded-xl border border-slate-200 dark:border-dark-border bg-white dark:bg-[#252525] text-left hover:border-brand-300 transition-all group" data-value="custom">
                        <div class="flex justify-between items-start mb-1">
                            <i class="fa-solid fa-sliders text-xs text-slate-400 group-[.active]:text-brand-500"></i>
                            <div class="w-2 h-2 rounded-full bg-slate-200 group-[.active]:bg-brand-500"></div>
                        </div>
                        <div class="text-xs font-semibold">Custom</div>
                        <div class="text-[10px] text-slate-400 opacity-80">Set Size</div>
                    </button>
                </div>

                <!-- Custom Size Input (Hidden) -->
                <div id="customSizeContainer" class="hidden animate-fade-in-down">
                    <div class="relative">
                        <input type="number" id="targetSizeInput" placeholder="Max File Size (MB)" step="0.1" min="0.1" 
                            class="w-full bg-white dark:bg-[#252525] border border-slate-200 dark:border-dark-border rounded-xl py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all">
                        <span class="absolute right-3 top-2 text-xs text-slate-400 font-medium">MB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="p-6 border-t border-slate-200 dark:border-dark-border bg-slate-50 dark:bg-[#151515]">
            <button id="mergeBtn" class="w-full bg-brand-600 hover:bg-brand-700 text-white py-3.5 rounded-xl text-sm font-bold shadow-lg shadow-brand-500/30 flex items-center justify-center gap-2 transition-all transform active:scale-[0.98] mb-3">
                <span id="btnText">Merge & Download</span>
                <div id="btnLoader" class="loader hidden"></div>
            </button>
            <div class="flex justify-between items-center px-1">
                <button id="clearBtn" class="text-xs font-medium text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1.5">
                    <i class="fa-solid fa-trash-can"></i> Clear All
                </button>
                <button id="themeToggle" class="text-xs font-medium text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors flex items-center gap-1.5">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:block"></i>
                    <span class="dark:hidden">Dark Mode</span>
                    <span class="hidden dark:block">Light Mode</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Workspace -->
    <main class="flex-grow flex flex-col relative overflow-hidden">
        <!-- Top Shadow Overlay for aesthetics -->
        <div class="absolute top-0 left-0 right-0 h-8 bg-gradient-to-b from-[#F8FAFC] to-transparent dark:from-dark-bg z-10 pointer-events-none"></div>

        <div class="flex-grow overflow-y-auto p-8 lg:p-12 relative">
            <div class="max-w-7xl mx-auto h-full flex flex-col">
                
                <!-- Drop Zone -->
                <div id="dropZone" class="drop-zone group relative w-full h-48 lg:h-56 rounded-[24px] flex flex-col items-center justify-center cursor-pointer mb-10 transition-all hover:bg-white hover:shadow-soft dark:hover:bg-[#1A1A1A]">
                    <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" multiple accept="image/jpeg,image/png,application/pdf">
                    
                    <div class="w-16 h-16 rounded-2xl bg-white dark:bg-[#252525] shadow-soft flex items-center justify-center mb-4 group-hover:scale-110 group-hover:-translate-y-1 transition-all duration-300 border border-slate-100 dark:border-dark-border">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl text-brand-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-1">Click or Drop files here</h3>
                    <p class="text-sm text-slate-400">PDF, PNG, JPG supported</p>
                </div>

                <!-- Content Grid -->
                <div id="fileGrid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6 pb-20">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="flex-grow flex flex-col items-center justify-center text-center opacity-40 select-none pb-32">
                    <div class="w-32 h-32 rounded-full bg-slate-100 dark:bg-dark-surface flex items-center justify-center mb-6">
                        <i class="fa-regular fa-folder-open text-4xl text-slate-300 dark:text-slate-600"></i>
                    </div>
                    <p class="text-slate-400 font-medium text-lg">Your workspace is empty</p>
                    <p class="text-slate-300 text-sm mt-2 max-w-xs">Drag documents from your computer to begin merging</p>
                </div>
            </div>
        </div>

        <!-- Status Bar / Info -->
        <div id="compressionMsg" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white dark:bg-dark-surface border border-brand-100 dark:border-brand-900 shadow-xl rounded-full px-6 py-3 flex items-center gap-3 transform translate-y-20 transition-transform duration-300 z-30">
            <div class="w-2 h-2 rounded-full bg-brand-500 animate-pulse"></div>
            <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Optimizing file size...</span>
        </div>
    </main>

    <!-- Crop Modal -->
    <div id="cropModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-6">
        <div class="bg-white dark:bg-dark-surface rounded-3xl shadow-2xl w-full max-w-5xl flex flex-col h-[85vh] overflow-hidden border border-white/20">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-dark-border flex justify-between items-center bg-white dark:bg-dark-surface z-10">
                <div>
                    <h3 class="font-bold text-lg text-slate-900 dark:text-white">Crop Image</h3>
                    <p class="text-xs text-slate-500">Adjust the frame to crop your image</p>
                </div>
                <button onclick="closeCropModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-dark-bg hover:bg-slate-200 dark:hover:bg-[#333] flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-xmark text-slate-500"></i>
                </button>
            </div>
            <div class="flex-grow bg-[#0F0F0F] relative overflow-hidden flex items-center justify-center">
                <img id="cropImageTarget" src="" class="max-w-full max-h-full block">
            </div>
            <div class="p-6 border-t border-slate-100 dark:border-dark-border bg-white dark:bg-dark-surface flex justify-end gap-3 z-10">
                <button onclick="closeCropModal()" class="px-5 py-2.5 rounded-xl text-sm text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-50 dark:hover:bg-dark-bg transition-colors">Cancel</button>
                <button onclick="applyCrop()" class="px-8 py-2.5 rounded-xl text-sm text-white bg-brand-600 font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/20 transition-all hover:-translate-y-0.5">Apply Crop</button>
            </div>
        </div>
    </div>

    <script>
        // --- Dark Mode Logic ---
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
        });

        // --- Core App State ---
        let files = []; 
        let currentCropId = null;
        let cropper = null;
        let currentQualityMode = 'medium'; // small, medium, best, custom

        // --- DOM Elements ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileGrid = document.getElementById('fileGrid');
        const emptyState = document.getElementById('emptyState');
        const targetSizeInput = document.getElementById('targetSizeInput');
        const customSizeContainer = document.getElementById('customSizeContainer');
        const filenameInput = document.getElementById('filenameInput');
        const compressionMsg = document.getElementById('compressionMsg');

        // --- Quality Preset Logic ---
        const presetBtns = document.querySelectorAll('.quality-option');
        presetBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                presetBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentQualityMode = btn.dataset.value;
                if(currentQualityMode === 'custom') {
                    customSizeContainer.classList.remove('hidden');
                    targetSizeInput.focus();
                } else {
                    customSizeContainer.classList.add('hidden');
                    targetSizeInput.value = ''; 
                }
            });
        });

        // --- Drag & Drop ---
        new Sortable(fileGrid, {
            animation: 200,
            ghostClass: 'opacity-40',
            dragClass: 'cursor-grabbing',
            onEnd: (evt) => {
                const movedItem = files.splice(evt.oldIndex, 1)[0];
                files.splice(evt.newIndex, 0, movedItem);
            },
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            handleFiles({ target: { files: e.dataTransfer.files } });
        }

        async function handleFiles(e) {
            const newFiles = [...e.target.files];
            for (const file of newFiles) {
                if (file.type === 'application/pdf' || file.type.startsWith('image/')) {
                    await addFile(file);
                }
            }
            renderGrid();
        }

        // --- File Handling ---
        async function addFile(file) {
            const id = Math.random().toString(36).substr(2, 9);
            const isPdf = file.type === 'application/pdf';
            let preview = '';
            
            if (isPdf) {
                preview = await generatePdfThumbnail(file);
            } else {
                preview = await readFileAsDataURL(file);
            }

            files.push({
                id,
                file,
                type: isPdf ? 'pdf' : 'img',
                preview,
                rotation: 0
            });
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        async function generatePdfThumbnail(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 0.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                return canvas.toDataURL();
            } catch (e) {
                console.error("PDF Thumbnail error", e);
                return ''; 
            }
        }

        // --- Rendering ---
        function renderGrid() {
            fileGrid.innerHTML = '';
            if (files.length === 0) {
                emptyState.classList.remove('hidden');
                dropZone.classList.remove('h-40');
                dropZone.classList.add('h-48', 'lg:h-56'); // Larger dropzone when empty
                return;
            }
            emptyState.classList.add('hidden');
            dropZone.classList.remove('h-48', 'lg:h-56');
            dropZone.classList.add('h-32'); // Smaller dropzone when files exist

            files.forEach((item) => {
                const div = document.createElement('div');
                div.className = 'group relative bg-white dark:bg-dark-surface rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border border-slate-100 dark:border-dark-border overflow-hidden h-64 flex flex-col select-none cursor-grab active:cursor-grabbing';
                div.setAttribute('data-id', item.id);

                const isImg = item.type === 'img';
                
                div.innerHTML = `
                    <div class="relative h-44 bg-slate-50 dark:bg-[#151515] flex items-center justify-center overflow-hidden p-4">
                        <img src="${item.preview}" class="object-contain w-full h-full shadow-lg rounded-sm transition-transform duration-300" 
                             style="transform: rotate(${item.rotation}deg)">
                        
                        <div class="absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-3 backdrop-blur-[2px]">
                            <button onclick="rotateFile('${item.id}')" class="w-10 h-10 bg-white/20 hover:bg-white text-white hover:text-slate-900 rounded-full backdrop-blur-md transition-all flex items-center justify-center" title="Rotate">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                            ${isImg ? `
                            <button onclick="initCrop('${item.id}')" class="w-10 h-10 bg-white/20 hover:bg-white text-white hover:text-slate-900 rounded-full backdrop-blur-md transition-all flex items-center justify-center" title="Crop">
                                <i class="fa-solid fa-crop-simple"></i>
                            </button>` : ''}
                        </div>
                    </div>
                    <div class="p-4 bg-white dark:bg-dark-surface flex justify-between items-start flex-grow">
                        <div class="w-full">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-slate-500">${item.type}</span>
                                <button onclick="removeFile('${item.id}')" class="text-slate-300 hover:text-red-500 transition-colors">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                            <div class="truncate text-xs font-semibold text-slate-700 dark:text-slate-200" title="${item.file.name}">
                                ${item.file.name}
                            </div>
                            <div class="text-[10px] text-slate-400 mt-0.5">
                                ${(item.file.size / 1024 / 1024).toFixed(2)} MB
                            </div>
                        </div>
                    </div>
                `;
                fileGrid.appendChild(div);
            });
        }

        // --- Actions ---
        window.rotateFile = (id) => {
            const item = files.find(f => f.id === id);
            if (item) {
                item.rotation = (item.rotation + 90) % 360;
                renderGrid();
            }
        };

        window.removeFile = (id) => {
            files = files.filter(f => f.id !== id);
            renderGrid();
        };

        document.getElementById('clearBtn').addEventListener('click', () => {
            if (files.length > 0 && confirm('Clear all files?')) {
                files = [];
                renderGrid();
            }
        });

        // --- Cropping ---
        window.initCrop = (id) => {
            currentCropId = id;
            const item = files.find(f => f.id === id);
            if (!item || item.type !== 'img') return;
            const modal = document.getElementById('cropModal');
            const imageTarget = document.getElementById('cropImageTarget');
            imageTarget.src = item.preview;
            modal.classList.remove('hidden');
            if (cropper) cropper.destroy();
            cropper = new Cropper(imageTarget, { viewMode: 1, autoCropArea: 0.8, background: false });
        };

        window.closeCropModal = () => {
            document.getElementById('cropModal').classList.add('hidden');
            if (cropper) { cropper.destroy(); cropper = null; }
            currentCropId = null;
        };

        window.applyCrop = () => {
            if (!cropper || !currentCropId) return;
            const canvas = cropper.getCroppedCanvas();
            const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
            const item = files.find(f => f.id === currentCropId);
            if (item) {
                item.preview = croppedDataUrl;
                fetch(croppedDataUrl).then(res => res.blob()).then(blob => {
                    item.file = new File([blob], item.file.name, { type: "image/jpeg" });
                    item.rotation = 0;
                    renderGrid();
                    closeCropModal();
                });
            }
        };

        // --- PDF Merging & Compression Logic ---
        const { PDFDocument, rgb, degrees } = PDFLib;

        document.getElementById('mergeBtn').addEventListener('click', async () => {
            if (files.length === 0) return alert('Please add files first.');

            const btn = document.getElementById('mergeBtn');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('btnLoader');
            const userFilename = filenameInput.value.trim() || "merged_document";
            
            btn.disabled = true;
            btnText.textContent = "Processing";
            loader.classList.remove('hidden');

            try {
                // Determine Mode parameters
                const isIdMode = document.getElementById('idModeToggle').checked;
                const targetSizeMB = (currentQualityMode === 'custom') ? parseFloat(targetSizeInput.value) : null;
                
                // Map presets to initial quality values
                let initialQuality = 0.8;
                if (currentQualityMode === 'small') initialQuality = 0.3;
                if (currentQualityMode === 'medium') initialQuality = 0.6;
                if (currentQualityMode === 'best') initialQuality = 0.95;
                if (currentQualityMode === 'custom' && targetSizeMB) initialQuality = 0.9; 

                let currentQuality = initialQuality;
                let attempts = 0;
                let success = false;
                let finalPdfBytes = null;
                const MAX_ATTEMPTS = targetSizeMB ? 3 : 1; 

                while (attempts < MAX_ATTEMPTS && !success) {
                    if (targetSizeMB && attempts > 0) {
                        compressionMsg.classList.remove('translate-y-20');
                        currentQuality -= 0.3; 
                        if (currentQuality < 0.2) currentQuality = 0.2;
                    }

                    const pdfDoc = await PDFDocument.create();
                    
                    const compressImage = async (file, q) => {
                        return new Promise((resolve) => {
                            const img = new Image();
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                img.src = e.target.result;
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    let scale = 1;
                                    if (currentQualityMode === 'small') scale = 0.6; 
                                    if (q < 0.4) scale = 0.7; 
                                    
                                    canvas.width = img.width * scale;
                                    canvas.height = img.height * scale;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    resolve(canvas.toDataURL('image/jpeg', q));
                                };
                            };
                            reader.readAsDataURL(file);
                        });
                    };

                    if (isIdMode) {
                        const page = pdfDoc.addPage([595.28, 841.89]);
                        const pageWidth = page.getWidth();
                        const pageHeight = page.getHeight();
                        const targets = files.slice(0, 2);
                        let yPos = pageHeight / 2 + 50; 

                        for (const item of targets) {
                            if (item.type === 'pdf') {
                                const thumb = await generatePdfThumbnail(item.file);
                                const imgBytes = await fetch(thumb).then(res => res.arrayBuffer());
                                const embedImg = await pdfDoc.embedPng(imgBytes);
                                const dims = embedImg.scaleToFit(250, 250);
                                page.drawImage(embedImg, { x: (pageWidth - dims.width) / 2, y: yPos, width: dims.width, height: dims.height });
                            } else {
                                const compressedDataUrl = await compressImage(item.file, currentQuality);
                                const imgBytes = await fetch(compressedDataUrl).then(res => res.arrayBuffer());
                                const embedImg = await pdfDoc.embedJpg(imgBytes);
                                const dims = embedImg.scaleToFit(250, 250);
                                page.drawImage(embedImg, { x: (pageWidth - dims.width) / 2, y: yPos, width: dims.width, height: dims.height, rotate: degrees(item.rotation) });
                            }
                            yPos -= 300;
                        }
                    } else {
                        for (const item of files) {
                            if (item.type === 'pdf') {
                                const arrayBuffer = await item.file.arrayBuffer();
                                const srcPdf = await PDFDocument.load(arrayBuffer);
                                const copiedPages = await pdfDoc.copyPages(srcPdf, srcPdf.getPageIndices());
                                copiedPages.forEach((page) => {
                                    const existingRotation = page.getRotation().angle;
                                    page.setRotation(degrees(existingRotation + item.rotation));
                                    pdfDoc.addPage(page);
                                });
                            } else {
                                const compressedDataUrl = await compressImage(item.file, currentQuality);
                                const imgBytes = await fetch(compressedDataUrl).then(res => res.arrayBuffer());
                                const embedImg = await pdfDoc.embedJpg(imgBytes);
                                const page = pdfDoc.addPage([595.28, 841.89]);
                                const { width, height } = page.getSize();
                                const imgDims = embedImg.scale(1);
                                
                                let drawWidth = width;
                                let drawHeight = (imgDims.height / imgDims.width) * width;
                                if (drawHeight > height) {
                                    drawHeight = height;
                                    drawWidth = (imgDims.width / imgDims.height) * height;
                                }
                                
                                page.drawImage(embedImg, { x: (width - drawWidth) / 2, y: (height - drawHeight) / 2, width: drawWidth, height: drawHeight, rotate: degrees(item.rotation) });
                            }
                        }
                    }

                    finalPdfBytes = await pdfDoc.save();
                    const sizeInMB = finalPdfBytes.byteLength / (1024 * 1024);

                    if (targetSizeMB && sizeInMB > targetSizeMB) {
                        attempts++;
                        console.log(`Attempt ${attempts}: ${sizeInMB.toFixed(2)}MB > ${targetSizeMB}MB`);
                    } else {
                        success = true;
                    }
                } 

                download(finalPdfBytes, userFilename + ".pdf", "application/pdf");

            } catch (err) {
                console.error(err);
                alert('An error occurred during processing.');
            } finally {
                btn.disabled = false;
                btnText.textContent = "Merge & Download";
                loader.classList.add('hidden');
                compressionMsg.classList.add('translate-y-20');
            }
        });

        function download(data, filename, type) {
            const blob = new Blob([data], { type: type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
